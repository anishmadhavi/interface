name: Deploy to AWS Lightsail

on:
  push:
    branches:
      - main  # Runs whenever you push to main branch

env:
  SERVICE_NAME: interface-app  # Name this whatever you want
  AWS_REGION: ap-south-1
  IMAGE_NAME: interface-v2

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Lightsail Plugin
        run: |
          curl "https://s3.us-west-2.amazonaws.com/lightsailctl/latest/linux-amd64/lightsailctl" -o "lightsailctl"
          sudo mv lightsailctl /usr/local/bin/lightsailctl
          sudo chmod +x /usr/local/bin/lightsailctl

      - name: Build and Push Docker Image
        run: |
          # Create the service if it doesn't exist (Micro plan = Free Trial eligible)
          aws lightsail create-container-service --service-name ${{ env.SERVICE_NAME }} --power micro --scale 1 || true
          
          # Build image and push to Lightsail
          docker build -t ${{ env.IMAGE_NAME }} .
          aws lightsail push-container-image --service-name ${{ env.SERVICE_NAME }} --label ${{ env.IMAGE_NAME }} --image ${{ env.IMAGE_NAME }}

      - name: Deploy the Image
        run: |
          # Get the image name we just pushed
          IMAGE_TAG=$(aws lightsail get-container-images --service-name ${{ env.SERVICE_NAME }} | grep -o "${{ env.SERVICE_NAME }}.${{ env.IMAGE_NAME }}.[0-9]*" | head -n 1)
          
          # Update the service to use this new image on Port 3000 (Next.js default)
          aws lightsail create-container-service-deployment \
            --service-name ${{ env.SERVICE_NAME }} \
            --containers "{
              \"${{ env.IMAGE_NAME }}\": {
                \"image\": \"$IMAGE_TAG\",
                \"ports\": {\"3000\": \"HTTP\"},
                \"environment\": {
                  \"NEXT_PUBLIC_SUPABASE_URL\": \"${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}\",
                  \"NEXT_PUBLIC_SUPABASE_ANON_KEY\": \"${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}\"
                }
              }
            }" \
            --public-endpoint "{\"containerName\": \"${{ env.IMAGE_NAME }}\", \"containerPort\": 3000, \"healthCheck\": {\"path\": \"/\"}}"
